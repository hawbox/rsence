<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>Module: Himle::Server::TicketService::Common</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Script-Type" content="text/javascript" />
  <link rel="stylesheet" href="../../../.././rdoc-style.css" type="text/css" media="screen" />
  <script type="text/javascript">
  // <![CDATA[

  function popupCode( url ) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }

  function toggleCode( id ) {
    if ( document.getElementById )
      elem = document.getElementById( id );
    else if ( document.all )
      elem = eval( "document.all." + id );
    else
      return false;

    elemStyle = elem.style;
    
    if ( elemStyle.display != "block" ) {
      elemStyle.display = "block"
    } else {
      elemStyle.display = "none"
    }

    return true;
  }
  
  // Make codeblocks hidden by default
  document.writeln( "<style type=\"text/css\">div.method-source-code { display: none }</style>" )
  
  // ]]>
  </script>

</head>
<body>



    <div id="classHeader">
        <table class="header-table">
        <tr class="top-aligned-row">
          <td><strong>Module</strong></td>
          <td class="class-name-in-header">Himle::Server::TicketService::Common</td>
        </tr>
        <tr class="top-aligned-row">
            <td><strong>In:</strong></td>
            <td>
                <a href="../../../../files/lib/file/ticketservices/common_rb.html">
                lib/file/ticketservices/common.rb
                </a>
        <br />
            </td>
        </tr>

        </table>
    </div>
  <!-- banner header -->

  <div id="bodyContent">



  <div id="contextContent">
    <div id="diagram">
      <map id="map" name="map">
  <area shape="rect" coords="1385,5,1457,53"      href="../../../Array.html" alt="Array" />
  <area shape="rect" coords="1368,180,1475,228"      href="../ResponseBody.html" alt="ResponseBody" />
  <area shape="rect" coords="1959,276,2031,324"      href="../Broker.html" alt="Broker" />
  <area shape="rect" coords="2859,276,2947,324"      href="../TicketServe.html" alt="TicketServe" />
  <area shape="rect" coords="2117,180,2189,228"      href="../Daemon/Base.html" alt="Base" />
  <area shape="rect" coords="2109,276,2197,324"      href="../HimleServe.html" alt="HimleServe" />
  <area shape="rect" coords="1739,5,1811,53"      href="../../../String.html" alt="String" />
  <area shape="rect" coords="1747,180,1819,228"      href="../GZString.html" alt="GZString" />
  <area shape="rect" coords="1632,180,1723,228"      href="../ValueParser.html" alt="ValueParser" />
  <area shape="rect" coords="1404,276,1508,324"      href="../IntValueParser.html" alt="IntValueParser" />
  <area shape="rect" coords="1532,276,1647,324"      href="../BoolValueParser.html" alt="BoolValueParser" />
  <area shape="rect" coords="1671,276,1793,324"      href="../StringValueParser.html" alt="StringValueParser" />
  <area shape="rect" coords="1817,276,1935,324"      href="../FloatValueParser.html" alt="FloatValueParser" />
  <area shape="rect" coords="1499,180,1608,228"      href="../SessionStorage.html" alt="SessionStorage" />
  <area shape="rect" coords="1265,276,1380,324"      href="../SessionManager.html" alt="SessionManager" />
  <area shape="rect" coords="1835,5,1939,53"      href="../../../Rack/Request.html" alt="Rack::Request" />
  <area shape="rect" coords="1843,180,1915,228"      href="../Request.html" alt="Request" />
  <area shape="rect" coords="3288,5,3443,53"      href="../../../SOAP/RPC/HSoaplet.html" alt="::SOAP::RPC::HSoaplet" />
  <area shape="rect" coords="3320,180,3411,228"      href="../SOAP/SOAPServe.html" alt="SOAPServe" />
  <area shape="rect" coords="1243,180,1317,228"      href="../Message.html" alt="Message" />
  <area shape="rect" coords="1139,180,1219,228"      href="../IndexHtml.html" alt="IndexHtml" />
  <area shape="rect" coords="1043,180,1115,228"      href="../HValue.html" alt="HValue" />
  <area shape="rect" coords="931,180,1019,228"      href="../Transporter.html" alt="Transporter" />
  <area shape="rect" coords="800,180,907,228"      href="../PluginManager.html" alt="PluginManager" />
  <area shape="rect" coords="696,180,776,228"      href="../Response.html" alt="Response" />
  <area shape="rect" coords="592,180,672,228"      href="../FileCache.html" alt="FileCache" />
  <area shape="rect" coords="491,180,568,228"      href="../KeyValue.html" alt="KeyValue" />
  <area shape="rect" coords="376,180,467,228"      href="../SOAPPlugin.html" alt="SOAPPlugin" />
  <area shape="rect" coords="280,180,352,228"      href="../Plugin.html" alt="Plugin" />
  <area shape="rect" coords="181,180,256,228"      href="../FileServe.html" alt="FileServe" />
  <area shape="rect" coords="53,180,157,228"      href="../ValueManager.html" alt="ValueManager" />
  <area shape="rect" coords="2432,180,2504,228"      href="BlobObj.html" alt="BlobObj" />
  <area shape="rect" coords="3283,145,3421,239"      href="../SOAP.html" alt="SOAP" />
  <area shape="rect" coords="3168,168,3261,216"      href="Common.html" alt="Common" />
  <area shape="rect" coords="3064,168,3157,216"      href="ObjBlob.html" alt="ObjBlob" />
  <area shape="rect" coords="2960,168,3053,216"      href="Favicon.html" alt="Favicon" />
  <area shape="rect" coords="2856,168,2949,216"      href="Img.html" alt="Img" />
  <area shape="rect" coords="2752,168,2845,216"      href="Upload.html" alt="Upload" />
  <area shape="rect" coords="2648,168,2741,216"      href="Rsrc.html" alt="Rsrc" />
  <area shape="rect" coords="2544,168,2637,216"      href="File.html" alt="File" />
  <area shape="rect" coords="2421,133,3272,239"      href="../TicketService.html" alt="TicketService" />
  <area shape="rect" coords="2307,168,2400,216"      href="../Daemon/Controller.html" alt="Controller" />
  <area shape="rect" coords="2203,168,2296,216"      href="../Daemon/PidFile.html" alt="PidFile" />
  <area shape="rect" coords="2080,133,2411,239"      href="../Daemon.html" alt="Daemon" />
  <area shape="rect" coords="1952,168,2059,216"      href="../RestfulDispatcher/SingletonMethods.html" alt="SingletonMethods" />
  <area shape="rect" coords="1928,133,2069,227"      href="../RestfulDispatcher.html" alt="RestfulDispatcher" />
  <area shape="rect" coords="43,99,3432,335"      href="../../Server.html" alt="Server" />
  <area shape="rect" coords="16,64,3443,345"      href="../../../Himle.html" alt="Himle" />
</map>
<img src="../../../../dot/f_3.gif" usemap="#map" border="0" alt="dot/f_3.gif">
    </div>



   </div>

    <div id="method-list">
      <h3 class="section-bar">Methods</h3>

      <div class="name-list">
      <a href="#M000074">expire_ses</a>&nbsp;&nbsp;
      <a href="#M000075">get</a>&nbsp;&nbsp;
      <a href="#M000069">hexlify</a>&nbsp;&nbsp;
      <a href="#M000068">httime</a>&nbsp;&nbsp;
      <a href="#M000070">new</a>&nbsp;&nbsp;
      <a href="#M000072">serve</a>&nbsp;&nbsp;
      <a href="#M000073">serve_img</a>&nbsp;&nbsp;
      <a href="#M000071">shutdown</a>&nbsp;&nbsp;
      </div>
    </div>

  </div>


    <!-- if includes -->

    <div id="section">





    <div id="attribute-list">
      <h3 class="section-bar">Attributes</h3>

      <div class="name-list">
        <table>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">content_types</td>
          <td class="context-item-value">&nbsp;[RW]&nbsp;</td>
          <td class="context-item-desc"></td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">imgs</td>
          <td class="context-item-value">&nbsp;[RW]&nbsp;</td>
          <td class="context-item-desc"></td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">raw_uris</td>
          <td class="context-item-value">&nbsp;[RW]&nbsp;</td>
          <td class="context-item-desc"></td>
        </tr>
        </table>
      </div>
    </div>
      


    <!-- if method_list -->
    <div id="methods">
      <h3 class="section-bar">Public Class methods</h3>

      <div id="method-M000070" class="method-detail">
        <a name="M000070"></a>

        <div class="method-heading">
          <a href="#M000070" class="method-signature">
          <span class="method-name">new</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Initializes storage
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000070-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000070-source">
<pre>
    <span class="ruby-comment cmt"># File lib/file/ticketservices/common.rb, line 19</span>
19:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">initialize</span>
20:     
21:     <span class="ruby-comment cmt"># storage for tickets to be expired by expiry time</span>
22:     <span class="ruby-comment cmt"># as the key and an array of ids in array as the value</span>
23:     <span class="ruby-ivar">@expires</span> = {}
24:     <span class="ruby-ivar">@expire_files</span> = {}
25:     <span class="ruby-ivar">@expire_blobobj</span> = {}
26:     
27:     <span class="ruby-comment cmt"># storage for disposable images</span>
28:     <span class="ruby-ivar">@imgs</span> = {
29:       
30:       <span class="ruby-comment cmt"># id is used as the uri</span>
31:       <span class="ruby-identifier">:by_id</span>   =<span class="ruby-operator">&gt;</span> {},
32:       
33:       <span class="ruby-comment cmt"># list of image ids by session id</span>
34:       <span class="ruby-identifier">:ses_ids</span> =<span class="ruby-operator">&gt;</span> {}
35:     }
36:     
37:     <span class="ruby-comment cmt"># storage for other disposable data</span>
38:     <span class="ruby-ivar">@files</span> = {
39:       
40:       <span class="ruby-comment cmt"># id is used as the uri</span>
41:       <span class="ruby-identifier">:by_id</span>   =<span class="ruby-operator">&gt;</span> {},
42:       
43:       <span class="ruby-comment cmt"># list of image ids by session id</span>
44:       <span class="ruby-identifier">:ses_ids</span> =<span class="ruby-operator">&gt;</span> {}
45:     }
46:     
47:     <span class="ruby-comment cmt"># an randgen instance used for generating ids (84B long)</span>
48:     <span class="ruby-ivar">@randgen</span> = <span class="ruby-constant">RandomGenerator</span>.<span class="ruby-identifier">new</span>( <span class="ruby-value">84</span>, <span class="ruby-value">600</span> )
49:     
50:     <span class="ruby-comment cmt"># supported image content types</span>
51:     <span class="ruby-ivar">@content_types</span> = {
52:       <span class="ruby-value str">'GIF'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'image/gif'</span>,
53:       <span class="ruby-value str">'PNG'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'image/png'</span>,
54:       <span class="ruby-value str">'JPG'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'image/jpeg'</span>
55:     }
56:     
57:     <span class="ruby-comment cmt"># static data, initially for invalid/not found error-gif</span>
58:     <span class="ruby-comment cmt"># also all serve_rsrc items</span>
59:     <span class="ruby-ivar">@raw_uris</span> = {
60:       <span class="ruby-value str">'invalid.gif'</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">'image/gif'</span>,<span class="ruby-value str">'53'</span>,[<span class="ruby-value str">'749464839316700090000800000000004e7ebe129f400000000000c200000000700090000020c0c8f70a9c810e0229ea2da1a000b3'</span>].<span class="ruby-identifier">pack</span>(<span class="ruby-value str">'h*'</span>)],
61:       <span class="ruby-value str">'favicon.ico'</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">'image/x-icon'</span>,<span class="ruby-value str">'350'</span>,[<span class="ruby-value str">'749464839316010001005d7200000000ffffff73190d7a27006e6fff6e7fffed8a01d85c0f3fcda9be4c8573191dcf7f7eed7a017a3700754acdcf6f6ebe5c855e7fff754addfd7a017bedeffd7af0d84c1f6bddef7bddffed8af0d85c1f755add6a2700c85c0f4fcda9ed7af04fbda97bddefcf6f7e654acd6bddffce5c853fbda9ffffff000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000129f401000007200c200000000010001000060b70c310683c391584408110286a2f8c47e250a01c379555c310217c6ea249c8c1bd385e006047e0a9d25e2894e0924a0d6b04880e5f4020e90b51028384828b530d0d030b830c1a8b8b5603151c0c0602960c0f191b50101522700903ab58080e196028062b5b0f0b096f0220bb468745b1075009b7b5b960605061400b3'</span>].<span class="ruby-identifier">pack</span>(<span class="ruby-value str">'h*'</span>)]
62:     }
63:     
64:     <span class="ruby-ivar">@upload_slots</span> = {
65:       <span class="ruby-comment cmt"># upload slots</span>
66:       <span class="ruby-identifier">:by_id</span> =<span class="ruby-operator">&gt;</span> {
67:         <span class="ruby-comment cmt"># random key      mime    max_size session_id </span>
68:         <span class="ruby-comment cmt"># 'test123'  =&gt; [ '*/*',  15000,   12         ]</span>
69:       },
70:       <span class="ruby-comment cmt"># processed uploads</span>
71:       <span class="ruby-identifier">:uploaded</span> =<span class="ruby-operator">&gt;</span> {
72:         <span class="ruby-comment cmt"># same key as :by_id  himle_uploads:id</span>
73:         <span class="ruby-comment cmt"># 'test123'  =&gt;       [37483,37546,38759]</span>
74:       },
75:       <span class="ruby-comment cmt"># upload ids by session id</span>
76:       <span class="ruby-identifier">:ses_ids</span> =<span class="ruby-operator">&gt;</span> {
77:         <span class="ruby-comment cmt"># 12 =&gt; ['test123']</span>
78:       }
79:     }
80:     
81:     <span class="ruby-ivar">@blob_objs</span> = {
82:       <span class="ruby-identifier">:by_id</span>   =<span class="ruby-operator">&gt;</span> {},
83:       <span class="ruby-identifier">:ses_ids</span> =<span class="ruby-operator">&gt;</span> {}
84:     }
85:     
86:     <span class="ruby-identifier">auth_setup</span> = <span class="ruby-identifier">$config</span>[<span class="ruby-identifier">:database</span>][<span class="ruby-identifier">:auth_setup</span>] <span class="ruby-comment cmt"># himle-isolated account of mysql</span>
87:     <span class="ruby-ivar">@db</span> = <span class="ruby-constant">MySQLAbstractor</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">auth_setup</span>, <span class="ruby-identifier">auth_setup</span>[<span class="ruby-identifier">:db</span>])
88:     
89:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <h3 class="section-bar">Public Instance methods</h3>

      <div id="method-M000074" class="method-detail">
        <a name="M000074"></a>

        <div class="method-heading">
          <a href="#M000074" class="method-signature">
          <span class="method-name">expire_ses</span><span class="method-args">( ses_id )</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
flushes disposable storage when the session expires
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000074-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000074-source">
<pre>
     <span class="ruby-comment cmt"># File lib/file/ticketservices/common.rb, line 153</span>
153:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">expire_ses</span>( <span class="ruby-identifier">ses_id</span> )
154:     
155:     <span class="ruby-comment cmt"># flush images by session id</span>
156:     <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@imgs</span>[<span class="ruby-identifier">:ses_ids</span>].<span class="ruby-identifier">has_key?</span>(<span class="ruby-identifier">ses_id</span>)
157:       
158:       <span class="ruby-comment cmt"># goes through the array, until it's empty</span>
159:       <span class="ruby-keyword kw">until</span> <span class="ruby-ivar">@imgs</span>[<span class="ruby-identifier">:ses_ids</span>][<span class="ruby-identifier">ses_id</span>].<span class="ruby-identifier">empty?</span>
160:         <span class="ruby-identifier">img_id</span> = <span class="ruby-ivar">@imgs</span>[<span class="ruby-identifier">:ses_ids</span>][<span class="ruby-identifier">ses_id</span>].<span class="ruby-identifier">shift</span>
161:         <span class="ruby-identifier">del_img</span>( <span class="ruby-identifier">img_id</span>, <span class="ruby-identifier">ses_id</span> )
162:       <span class="ruby-keyword kw">end</span>
163:       
164:       <span class="ruby-comment cmt"># finally, removes the session id</span>
165:       <span class="ruby-ivar">@imgs</span>[<span class="ruby-identifier">:ses_ids</span>].<span class="ruby-identifier">delete</span>( <span class="ruby-identifier">ses_id</span> )
166:     <span class="ruby-keyword kw">end</span>
167:     
168:     <span class="ruby-comment cmt"># flush other data by session id</span>
169:     <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@files</span>[<span class="ruby-identifier">:ses_ids</span>].<span class="ruby-identifier">has_key?</span>(<span class="ruby-identifier">ses_id</span>)
170:       
171:       <span class="ruby-comment cmt"># goes through the array, until it's empty</span>
172:       <span class="ruby-keyword kw">until</span> <span class="ruby-ivar">@files</span>[<span class="ruby-identifier">:ses_ids</span>][<span class="ruby-identifier">ses_id</span>].<span class="ruby-identifier">empty?</span>
173:         <span class="ruby-identifier">file_id</span> = <span class="ruby-ivar">@files</span>[<span class="ruby-identifier">:ses_ids</span>][<span class="ruby-identifier">ses_id</span>].<span class="ruby-identifier">shift</span>
174:         <span class="ruby-identifier">del_file</span>( <span class="ruby-identifier">file_id</span>, <span class="ruby-identifier">ses_id</span> )
175:       <span class="ruby-keyword kw">end</span>
176:       
177:       <span class="ruby-comment cmt"># finally, removes the session id</span>
178:       <span class="ruby-ivar">@files</span>[<span class="ruby-identifier">:ses_ids</span>].<span class="ruby-identifier">delete</span>( <span class="ruby-identifier">ses_id</span> )
179:     <span class="ruby-keyword kw">end</span>
180:     
181:     <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@upload_slots</span>[<span class="ruby-identifier">:ses_ids</span>].<span class="ruby-identifier">has_key?</span>(<span class="ruby-identifier">ses_id</span>)
182:       <span class="ruby-comment cmt"># goes through the array, until it's empty</span>
183:       <span class="ruby-keyword kw">until</span> <span class="ruby-ivar">@upload_slots</span>[<span class="ruby-identifier">:ses_ids</span>][<span class="ruby-identifier">ses_id</span>].<span class="ruby-identifier">empty?</span>
184:         <span class="ruby-identifier">ticket_id</span> = <span class="ruby-ivar">@upload_slots</span>[<span class="ruby-identifier">:ses_ids</span>][<span class="ruby-identifier">ses_id</span>].<span class="ruby-identifier">shift</span>
185:         <span class="ruby-identifier">del_uploads</span>( <span class="ruby-identifier">ticket_id</span>, <span class="ruby-identifier">ses_id</span> )
186:       <span class="ruby-keyword kw">end</span>
187:       
188:       <span class="ruby-comment cmt"># finally, removes the session id</span>
189:       <span class="ruby-ivar">@upload_slots</span>[<span class="ruby-identifier">:ses_ids</span>].<span class="ruby-identifier">delete</span>( <span class="ruby-identifier">ses_id</span> )
190:     <span class="ruby-keyword kw">end</span>
191:     
192:     <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@blob_objs</span>[<span class="ruby-identifier">:ses_ids</span>].<span class="ruby-identifier">has_key?</span>(<span class="ruby-identifier">ses_id</span>)
193:       <span class="ruby-comment cmt"># goes through the array, until it's empty</span>
194:       <span class="ruby-keyword kw">until</span> <span class="ruby-ivar">@blob_objs</span>[<span class="ruby-identifier">:ses_ids</span>][<span class="ruby-identifier">ses_id</span>].<span class="ruby-identifier">empty?</span>
195:         <span class="ruby-identifier">ticket_id</span> = <span class="ruby-ivar">@blob_objs</span>[<span class="ruby-identifier">:ses_ids</span>][<span class="ruby-identifier">ses_id</span>].<span class="ruby-identifier">shift</span>
196:         <span class="ruby-identifier">del_blobobj</span>( <span class="ruby-identifier">ticket_id</span>, <span class="ruby-identifier">ses_id</span> )
197:       <span class="ruby-keyword kw">end</span>
198:       
199:       <span class="ruby-comment cmt"># finally, removes the session id</span>
200:       <span class="ruby-ivar">@blob_objs</span>[<span class="ruby-identifier">:ses_ids</span>].<span class="ruby-identifier">delete</span>( <span class="ruby-identifier">ses_id</span> )
201:     <span class="ruby-keyword kw">end</span>
202:     
203:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000075" class="method-detail">
        <a name="M000075"></a>

        <div class="method-heading">
          <a href="#M000075" class="method-signature">
          <span class="method-name">get</span><span class="method-args">( req, res, type=:img )</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
serves stuff from <a href="Common.html#M000075">get</a>-request
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000075-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000075-source">
<pre>
     <span class="ruby-comment cmt"># File lib/file/ticketservices/common.rb, line 206</span>
206:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">get</span>( <span class="ruby-identifier">req</span>, <span class="ruby-identifier">res</span>, <span class="ruby-identifier">type</span>=<span class="ruby-identifier">:img</span> )
207:     
208:     <span class="ruby-identifier">is_invalid</span> = <span class="ruby-keyword kw">true</span>
209:     
210:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">type</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">:img</span>
211:       
212:       <span class="ruby-identifier">img_id</span> = <span class="ruby-identifier">req</span>.<span class="ruby-identifier">unparsed_uri</span>.<span class="ruby-identifier">split</span>(<span class="ruby-value str">'/i/'</span>)[<span class="ruby-value">1</span>]
213:       
214:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">img_id</span> <span class="ruby-operator">==</span> <span class="ruby-keyword kw">nil</span>
215:         <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;ImgServe.fetch_img: invalid uri#1 (#{req.unparsed_uri.inspect})&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">$DEBUG_MODE</span>
216:         <span class="ruby-identifier">img_id</span> = <span class="ruby-value str">'invalid.gif'</span>
217:       <span class="ruby-keyword kw">end</span>
218:       
219:       <span class="ruby-identifier">img_id</span> = <span class="ruby-identifier">img_id</span>.<span class="ruby-identifier">split</span>(<span class="ruby-value str">'.'</span>)[<span class="ruby-value">0</span>]
220:       
221:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">img_id</span> <span class="ruby-operator">==</span> <span class="ruby-keyword kw">nil</span>
222:         <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;ImgServe.fetch_img: invalid uri#2 (#{req.unparsed_uri.inspect})&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">$DEBUG_MODE</span>
223:         <span class="ruby-identifier">img_id</span> = <span class="ruby-value str">'invalid.gif'</span>
224:       
225:       <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">img_id</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">!=</span> <span class="ruby-value">84</span>
226:         <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;ImgServe.fetch_img: invalid img_id (#{img_id.inspect})&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">$DEBUG_MODE</span>
227:         <span class="ruby-identifier">img_id</span> = <span class="ruby-value str">'invalid.gif'</span>
228:       <span class="ruby-keyword kw">end</span>
229:       
230:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@raw_uris</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">img_id</span>)
231:         (<span class="ruby-identifier">content_type</span>,<span class="ruby-identifier">content_size</span>,<span class="ruby-identifier">content</span>) = <span class="ruby-ivar">@raw_uris</span>[<span class="ruby-identifier">img_id</span>]
232:         
233:       <span class="ruby-keyword kw">elsif</span> <span class="ruby-ivar">@imgs</span>[<span class="ruby-identifier">:by_id</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">img_id</span>)
234:         
235:         (<span class="ruby-identifier">format</span>,<span class="ruby-identifier">content_size_zero</span>,<span class="ruby-identifier">img_data</span>,<span class="ruby-identifier">ses_id</span>) = <span class="ruby-ivar">@imgs</span>[<span class="ruby-identifier">:by_id</span>][<span class="ruby-identifier">img_id</span>]
236:         
237:         <span class="ruby-comment cmt"># renders the Magick::Image object</span>
238:         <span class="ruby-identifier">content</span> = <span class="ruby-identifier">img_data</span>.<span class="ruby-identifier">to_blob</span> {
239:           <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">format</span> = <span class="ruby-identifier">format</span>
240:         }
241:       
242:         <span class="ruby-comment cmt"># content size for the header</span>
243:         <span class="ruby-identifier">content_size</span> = <span class="ruby-identifier">content</span>.<span class="ruby-identifier">size</span>.<span class="ruby-identifier">to_s</span>
244:       
245:         <span class="ruby-comment cmt"># content type for the header</span>
246:         <span class="ruby-identifier">content_type</span> = <span class="ruby-ivar">@content_types</span>[<span class="ruby-identifier">format</span>]
247:         
248:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">req</span>.<span class="ruby-identifier">header</span>.<span class="ruby-identifier">has_key?</span>(<span class="ruby-value str">'keep-alive'</span>) <span class="ruby-keyword kw">and</span> <span class="ruby-identifier">req</span>.<span class="ruby-identifier">header</span>[<span class="ruby-value str">'keep-alive'</span>].<span class="ruby-identifier">size</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
249:           <span class="ruby-identifier">keep_alive</span> = <span class="ruby-identifier">req</span>.<span class="ruby-identifier">header</span>[<span class="ruby-value str">'keep-alive'</span>][<span class="ruby-value">0</span>].<span class="ruby-identifier">to_i</span>
250:           <span class="ruby-identifier">keep_alive</span> = <span class="ruby-value">10</span>  <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">keep_alive</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">10</span>
251:           <span class="ruby-identifier">keep_alive</span> = <span class="ruby-value">600</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">keep_alive</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">600</span>
252:           <span class="ruby-identifier">push_keepalive</span>( <span class="ruby-identifier">img_id</span>, <span class="ruby-identifier">keep_alive</span> )
253:           <span class="ruby-identifier">expire_keepalives</span>
254:         <span class="ruby-keyword kw">else</span>
255:           <span class="ruby-identifier">del_img</span>( <span class="ruby-identifier">img_id</span>, <span class="ruby-identifier">ses_id</span> )
256:         <span class="ruby-keyword kw">end</span>
257:       <span class="ruby-keyword kw">else</span>
258:         (<span class="ruby-identifier">content_type</span>,<span class="ruby-identifier">content_size</span>,<span class="ruby-identifier">content</span>) = <span class="ruby-ivar">@raw_uris</span>[<span class="ruby-value str">'invalid.gif'</span>]
259:       <span class="ruby-keyword kw">end</span>
260:       
261:     
262:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">type</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">:file</span>
263:       <span class="ruby-identifier">file_id</span> = <span class="ruby-identifier">req</span>.<span class="ruby-identifier">unparsed_uri</span>.<span class="ruby-identifier">split</span>(<span class="ruby-value str">'/f/'</span>)[<span class="ruby-value">1</span>]
264:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">file_id</span> <span class="ruby-operator">==</span> <span class="ruby-keyword kw">nil</span>
265:         <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;fileServe.fetch_file: invalid uri#1 (#{req.unparsed_uri.inspect})&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">$DEBUG_MODE</span>
266:         <span class="ruby-identifier">file_id</span> = <span class="ruby-value str">'invalid.gif'</span>
267:       <span class="ruby-keyword kw">end</span>
268:       <span class="ruby-identifier">file_id</span> = <span class="ruby-identifier">file_id</span>.<span class="ruby-identifier">split</span>(<span class="ruby-value str">'.'</span>)[<span class="ruby-value">0</span>]
269:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">file_id</span> <span class="ruby-operator">==</span> <span class="ruby-keyword kw">nil</span>
270:         <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;fileServe.fetch_file: invalid uri#2 (#{req.unparsed_uri.inspect})&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">$DEBUG_MODE</span>
271:         <span class="ruby-identifier">file_id</span> = <span class="ruby-value str">'invalid.gif'</span>
272:       <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">file_id</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">!=</span> <span class="ruby-value">84</span>
273:         <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;fileServe.fetch_file: invalid file_id (#{file_id.inspect})&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">$DEBUG_MODE</span>
274:         <span class="ruby-identifier">file_id</span> = <span class="ruby-value str">'invalid.gif'</span>
275:       <span class="ruby-keyword kw">end</span>
276:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@raw_uris</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">file_id</span>)
277:         (<span class="ruby-identifier">content_type</span>,<span class="ruby-identifier">content_size</span>,<span class="ruby-identifier">content</span>) = <span class="ruby-ivar">@raw_uris</span>[<span class="ruby-identifier">file_id</span>]
278:       <span class="ruby-keyword kw">elsif</span> <span class="ruby-ivar">@files</span>[<span class="ruby-identifier">:by_id</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">file_id</span>)
279:         (<span class="ruby-identifier">content_type</span>,<span class="ruby-identifier">content_size</span>,<span class="ruby-identifier">content</span>,<span class="ruby-identifier">ses_id</span>) = <span class="ruby-ivar">@files</span>[<span class="ruby-identifier">:by_id</span>][<span class="ruby-identifier">file_id</span>]
280:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">req</span>.<span class="ruby-identifier">header</span>.<span class="ruby-identifier">has_key?</span>(<span class="ruby-value str">'keep-alive'</span>) <span class="ruby-keyword kw">and</span> <span class="ruby-identifier">req</span>.<span class="ruby-identifier">header</span>[<span class="ruby-value str">'keep-alive'</span>].<span class="ruby-identifier">size</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
281:           <span class="ruby-identifier">keep_alive</span> = <span class="ruby-identifier">req</span>.<span class="ruby-identifier">header</span>[<span class="ruby-value str">'keep-alive'</span>][<span class="ruby-value">0</span>].<span class="ruby-identifier">to_i</span>
282:           <span class="ruby-identifier">keep_alive</span> = <span class="ruby-value">10</span>  <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">keep_alive</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">10</span>
283:           <span class="ruby-identifier">keep_alive</span> = <span class="ruby-value">600</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">keep_alive</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">600</span>
284:           <span class="ruby-identifier">push_keepalive_file</span>( <span class="ruby-identifier">file_id</span>, <span class="ruby-identifier">keep_alive</span> )
285:           <span class="ruby-identifier">expire_keepalive_files</span>
286:         <span class="ruby-keyword kw">else</span>
287:           <span class="ruby-identifier">del_file</span>( <span class="ruby-identifier">file_id</span>, <span class="ruby-identifier">ses_id</span> )
288:         <span class="ruby-keyword kw">end</span>
289:       <span class="ruby-keyword kw">else</span>
290:         (<span class="ruby-identifier">content_type</span>,<span class="ruby-identifier">content_size</span>,<span class="ruby-identifier">content</span>) = <span class="ruby-ivar">@raw_uris</span>[<span class="ruby-value str">'invalid.gif'</span>]
291:       <span class="ruby-keyword kw">end</span>
292:     
293:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">type</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">:blobobj</span>
294:       <span class="ruby-identifier">blobobj_id</span> = <span class="ruby-identifier">req</span>.<span class="ruby-identifier">unparsed_uri</span>.<span class="ruby-identifier">split</span>(<span class="ruby-value str">'/b/'</span>)[<span class="ruby-value">1</span>]
295:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">blobobj_id</span> <span class="ruby-operator">==</span> <span class="ruby-keyword kw">nil</span>
296:         <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;fileServe.fetch_blobobj: invalid uri#1 (#{req.unparsed_uri.inspect})&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">$DEBUG_MODE</span>
297:         <span class="ruby-identifier">blobobj_id</span> = <span class="ruby-value str">'invalid.gif'</span>
298:       <span class="ruby-keyword kw">end</span>
299:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">blobobj_id</span> <span class="ruby-operator">==</span> <span class="ruby-keyword kw">nil</span>
300:         <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;fileServe.fetch_blobobj: invalid uri#2 (#{req.unparsed_uri.inspect})&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">$DEBUG_MODE</span>
301:         <span class="ruby-identifier">blobobj_id</span> = <span class="ruby-value str">'invalid.gif'</span>
302:       <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">blobobj_id</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">!=</span> <span class="ruby-value">84</span>
303:         <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;fileServe.fetch_blobobj: invalid blobobj_id (#{blobobj_id.inspect})&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">$DEBUG_MODE</span>
304:         <span class="ruby-identifier">blobobj_id</span> = <span class="ruby-value str">'invalid.gif'</span>
305:       <span class="ruby-keyword kw">end</span>
306:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@raw_uris</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">blobobj_id</span>)
307:         <span class="ruby-identifier">content_type</span> = <span class="ruby-ivar">@raw_uris</span>[<span class="ruby-identifier">blobobj_id</span>].<span class="ruby-identifier">mime</span>
308:         <span class="ruby-identifier">content_size</span> = <span class="ruby-ivar">@raw_uris</span>[<span class="ruby-identifier">blobobj_id</span>].<span class="ruby-identifier">size</span>
309:         <span class="ruby-identifier">content</span>      = <span class="ruby-ivar">@raw_uris</span>[<span class="ruby-identifier">blobobj_id</span>].<span class="ruby-identifier">data</span>
310:       <span class="ruby-keyword kw">elsif</span> <span class="ruby-ivar">@blob_objs</span>[<span class="ruby-identifier">:by_id</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">blobobj_id</span>)
311:         (<span class="ruby-identifier">ses_id</span>, <span class="ruby-identifier">blobobj</span>) = <span class="ruby-ivar">@blob_objs</span>[<span class="ruby-identifier">:by_id</span>][<span class="ruby-identifier">blobobj_id</span>]
312:         <span class="ruby-identifier">content_type</span> = <span class="ruby-identifier">blobobj</span>.<span class="ruby-identifier">mime</span>
313:         <span class="ruby-identifier">content_size</span> = <span class="ruby-identifier">blobobj</span>.<span class="ruby-identifier">size</span>
314:         <span class="ruby-identifier">content</span>      = <span class="ruby-identifier">blobobj</span>.<span class="ruby-identifier">data</span>
315:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">req</span>.<span class="ruby-identifier">header</span>.<span class="ruby-identifier">has_key?</span>(<span class="ruby-value str">'keep-alive'</span>) <span class="ruby-keyword kw">and</span> <span class="ruby-identifier">req</span>.<span class="ruby-identifier">header</span>[<span class="ruby-value str">'keep-alive'</span>].<span class="ruby-identifier">size</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
316:           <span class="ruby-identifier">keep_alive</span> = <span class="ruby-identifier">req</span>.<span class="ruby-identifier">header</span>[<span class="ruby-value str">'keep-alive'</span>][<span class="ruby-value">0</span>].<span class="ruby-identifier">to_i</span>
317:           <span class="ruby-identifier">keep_alive</span> = <span class="ruby-value">10</span>  <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">keep_alive</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">10</span>
318:           <span class="ruby-identifier">keep_alive</span> = <span class="ruby-value">600</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">keep_alive</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">600</span>
319:           <span class="ruby-identifier">push_keepalive_blobobj</span>( <span class="ruby-identifier">blobobj_id</span>, <span class="ruby-identifier">keep_alive</span> )
320:           <span class="ruby-identifier">expire_keepalive_blobobjs</span>
321:         <span class="ruby-keyword kw">else</span>
322:           <span class="ruby-identifier">del_blobobj</span>( <span class="ruby-identifier">blobobj_id</span>, <span class="ruby-identifier">ses_id</span> )
323:         <span class="ruby-keyword kw">end</span>
324:       <span class="ruby-keyword kw">else</span>
325:         (<span class="ruby-identifier">content_type</span>,<span class="ruby-identifier">content_size</span>,<span class="ruby-identifier">content</span>) = <span class="ruby-ivar">@raw_uris</span>[<span class="ruby-value str">'invalid.gif'</span>]
326:       <span class="ruby-keyword kw">end</span>
327:       
328:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">type</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">:rsrc</span>
329:       <span class="ruby-identifier">rsrc_id</span> = <span class="ruby-identifier">req</span>.<span class="ruby-identifier">unparsed_uri</span>.<span class="ruby-identifier">split</span>(<span class="ruby-value str">'/d/'</span>)[<span class="ruby-value">1</span>]
330:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">rsrc_id</span> <span class="ruby-operator">==</span> <span class="ruby-keyword kw">nil</span>
331:         <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;rsrcServe.fetch_rsrc: invalid uri#1 (#{req.unparsed_uri.inspect})&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">$DEBUG_MODE</span>
332:         <span class="ruby-identifier">rsrc_id</span> = <span class="ruby-value str">'invalid.gif'</span>
333:       <span class="ruby-keyword kw">end</span>
334:       <span class="ruby-identifier">rsrc_id</span> = <span class="ruby-identifier">rsrc_id</span>.<span class="ruby-identifier">split</span>(<span class="ruby-value str">'.'</span>)[<span class="ruby-value">0</span>]
335:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">rsrc_id</span> <span class="ruby-operator">==</span> <span class="ruby-keyword kw">nil</span>
336:         <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;rsrcServe.fetch_rsrc: invalid uri#2 (#{req.unparsed_uri.inspect})&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">$DEBUG_MODE</span>
337:         <span class="ruby-identifier">rsrc_id</span> = <span class="ruby-value str">'invalid.gif'</span>
338:       <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">rsrc_id</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">!=</span> <span class="ruby-value">84</span>
339:         <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;rsrcServe.fetch_rsrc: invalid rsrc_id (#{rsrc_id.inspect})&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">$DEBUG_MODE</span>
340:         <span class="ruby-identifier">rsrc_id</span> = <span class="ruby-value str">'invalid.gif'</span>
341:       <span class="ruby-keyword kw">end</span>
342:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@raw_uris</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">rsrc_id</span>)
343:         (<span class="ruby-identifier">content_type</span>,<span class="ruby-identifier">content_size</span>,<span class="ruby-identifier">content</span>) = <span class="ruby-ivar">@raw_uris</span>[<span class="ruby-identifier">rsrc_id</span>]
344:       <span class="ruby-keyword kw">else</span>
345:         (<span class="ruby-identifier">content_type</span>,<span class="ruby-identifier">content_size</span>,<span class="ruby-identifier">content</span>) = <span class="ruby-ivar">@raw_uris</span>[<span class="ruby-value str">'invalid.gif'</span>]
346:       <span class="ruby-keyword kw">end</span>
347:     <span class="ruby-keyword kw">end</span>
348:     
349:     <span class="ruby-identifier">res</span>.<span class="ruby-identifier">status</span> = <span class="ruby-value">200</span>
350:     
351:     <span class="ruby-identifier">res</span>[<span class="ruby-value str">'Content-Type'</span>] = <span class="ruby-identifier">content_type</span>
352:     <span class="ruby-identifier">res</span>[<span class="ruby-value str">'Content-Size'</span>] = <span class="ruby-identifier">content_size</span>
353:     
354:     <span class="ruby-identifier">res</span>[<span class="ruby-value str">'Date'</span>] = <span class="ruby-identifier">httime</span>( <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span> )
355:     <span class="ruby-identifier">res</span>[<span class="ruby-value str">'Expires'</span>] = <span class="ruby-identifier">httime</span>(<span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span><span class="ruby-operator">+</span><span class="ruby-identifier">$config</span>[<span class="ruby-identifier">:cache_expire</span>])
356:     
357:     <span class="ruby-identifier">res</span>.<span class="ruby-identifier">body</span> = <span class="ruby-identifier">content</span>
358:     
359:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000069" class="method-detail">
        <a name="M000069"></a>

        <div class="method-heading">
          <a href="#M000069" class="method-signature">
          <span class="method-name">hexlify</span><span class="method-args">( str )</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Utility method for converting strings to hexadecimal
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000069-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000069-source">
<pre>
    <span class="ruby-comment cmt"># File lib/file/ticketservices/common.rb, line 14</span>
14:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">hexlify</span>( <span class="ruby-identifier">str</span> )
15:     <span class="ruby-node">&quot;0x#{str.unpack('H*')[0]}&quot;</span>
16:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000068" class="method-detail">
        <a name="M000068"></a>

        <div class="method-heading">
          <a href="#M000068" class="method-signature">
          <span class="method-name">httime</span><span class="method-args">(time)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Helper method to return the time formatted according to the HTTP RFC
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000068-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000068-source">
<pre>
    <span class="ruby-comment cmt"># File lib/file/ticketservices/common.rb, line 9</span>
 9:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">httime</span>(<span class="ruby-identifier">time</span>)
10:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">time</span>.<span class="ruby-identifier">gmtime</span>.<span class="ruby-identifier">strftime</span>(<span class="ruby-value str">'%a, %d %b %Y %H:%M:%S %Z'</span>)
11:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000072" class="method-detail">
        <a name="M000072"></a>

        <div class="method-heading">
          <a href="#M000072" class="method-signature">
          <span class="method-name">serve</span><span class="method-args">( msg, content, format='PNG', type=:img )</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
serves files and images
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000072-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000072-source">
<pre>
     <span class="ruby-comment cmt"># File lib/file/ticketservices/common.rb, line 96</span>
 96:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">serve</span>( <span class="ruby-identifier">msg</span>, <span class="ruby-identifier">content</span>, <span class="ruby-identifier">format</span>=<span class="ruby-value str">'PNG'</span>, <span class="ruby-identifier">type</span>=<span class="ruby-identifier">:img</span> )
 97:     
 98:     <span class="ruby-comment cmt"># gets a new, unique identifier</span>
 99:     <span class="ruby-identifier">ticket_id</span> = <span class="ruby-ivar">@randgen</span>.<span class="ruby-identifier">get_one</span>
100:     
101:     <span class="ruby-comment cmt"># serve image</span>
102:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">type</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">:img</span>
103:       
104:       <span class="ruby-comment cmt"># makes sure the format is in uppper case</span>
105:       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">upcase!</span>
106:       
107:       <span class="ruby-comment cmt"># checks, that the format is a supported image type</span>
108:       <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@content_types</span>.<span class="ruby-identifier">keys</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">format</span> )
109:         <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;ImgServe.serve: invalid format (#{format.inspect})&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">$DEBUG_MODE</span>
110:         <span class="ruby-keyword kw">return</span> <span class="ruby-value str">'/i/invalid.gif'</span>
111:       <span class="ruby-keyword kw">end</span>
112:       
113:       <span class="ruby-comment cmt"># changes the format to GIF for IE6</span>
114:       <span class="ruby-identifier">format</span> = <span class="ruby-value str">'GIF'</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">msg</span>.<span class="ruby-identifier">ie6</span> <span class="ruby-keyword kw">and</span> <span class="ruby-identifier">format</span> <span class="ruby-operator">==</span> <span class="ruby-value str">'PNG'</span>
115:       
116:       <span class="ruby-comment cmt"># stores the image data and meta-data ready to be served</span>
117:       <span class="ruby-identifier">storage_hash</span> = <span class="ruby-ivar">@imgs</span>
118:       <span class="ruby-identifier">storage_arr</span> = [<span class="ruby-identifier">format</span>,<span class="ruby-value">0</span>,<span class="ruby-identifier">content</span>,<span class="ruby-identifier">msg</span>.<span class="ruby-identifier">ses_id</span>]
119:       
120:       <span class="ruby-comment cmt"># return an uri that will respond to the data</span>
121:       <span class="ruby-identifier">uri</span> = <span class="ruby-node">&quot;/i/#{ticket_id}.#{format.downcase}&quot;</span>
122:     
123:     <span class="ruby-comment cmt"># serve file</span>
124:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">type</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">:file</span>
125:       
126:       <span class="ruby-comment cmt"># re-map content_type and filename meta-data from format</span>
127:       (<span class="ruby-identifier">content_type</span>, <span class="ruby-identifier">filename</span>) = <span class="ruby-identifier">format</span>
128:       
129:       <span class="ruby-comment cmt"># content size for the header</span>
130:       <span class="ruby-identifier">content_size</span> = <span class="ruby-identifier">content</span>.<span class="ruby-identifier">size</span>.<span class="ruby-identifier">to_s</span>
131:       
132:       <span class="ruby-identifier">storage_hash</span> = <span class="ruby-ivar">@files</span>
133:       <span class="ruby-identifier">storage_arr</span> = [<span class="ruby-identifier">content_type</span>,<span class="ruby-identifier">content_size</span>,<span class="ruby-identifier">content</span>,<span class="ruby-identifier">msg</span>.<span class="ruby-identifier">ses_id</span>,<span class="ruby-identifier">filename</span>]
134:       
135:       <span class="ruby-identifier">uri</span> = <span class="ruby-node">&quot;/f/#{ticket_id}&quot;</span>
136:     <span class="ruby-keyword kw">end</span>
137:     
138:     <span class="ruby-comment cmt"># makes sure, that the storage array has a sub-array for sessions (to aid session-based cleanup)</span>
139:     <span class="ruby-identifier">storage_hash</span>[<span class="ruby-identifier">:ses_ids</span>][<span class="ruby-identifier">msg</span>.<span class="ruby-identifier">ses_id</span>] = [] <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@imgs</span>[<span class="ruby-identifier">:ses_ids</span>].<span class="ruby-identifier">has_key?</span>(<span class="ruby-identifier">msg</span>.<span class="ruby-identifier">ses_id</span>)
140:     
141:     <span class="ruby-comment cmt"># adds the id to the session-specific storage</span>
142:     <span class="ruby-identifier">storage_hash</span>[<span class="ruby-identifier">:ses_ids</span>][<span class="ruby-identifier">msg</span>.<span class="ruby-identifier">ses_id</span>].<span class="ruby-identifier">push</span>( <span class="ruby-identifier">ticket_id</span> )
143:     
144:     <span class="ruby-identifier">storage_hash</span>[<span class="ruby-identifier">:by_id</span>][<span class="ruby-identifier">ticket_id</span>] = <span class="ruby-identifier">storage_arr</span>
145:     
146:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">uri</span>
147:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000073" class="method-detail">
        <a name="M000073"></a>

        <div class="method-heading">
          <span class="method-name">serve_img</span><span class="method-args">( msg, content, format='PNG', type=:img )</span>
        </div>
      
        <div class="method-description">
          <p>
Alias for <a href="Common.html#M000072">serve</a>
</p>
        </div>
      </div>

      <div id="method-M000071" class="method-detail">
        <a name="M000071"></a>

        <div class="method-heading">
          <a href="#M000071" class="method-signature">
          <span class="method-name">shutdown</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000071-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000071-source">
<pre>
    <span class="ruby-comment cmt"># File lib/file/ticketservices/common.rb, line 91</span>
91:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">shutdown</span>
92:     <span class="ruby-ivar">@db</span>.<span class="ruby-identifier">close</span>
93:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>


    </div>


  </div>


<div id="validator-badges">
  <p><small><a href="http://validator.w3.org/check/referer">[Validate]</a></small></p>
</div>

</body>
</html>