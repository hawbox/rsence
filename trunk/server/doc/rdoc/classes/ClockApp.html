<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>Class: ClockApp</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Script-Type" content="text/javascript" />
  <link rel="stylesheet" href=".././rdoc-style.css" type="text/css" media="screen" />
  <script type="text/javascript">
  // <![CDATA[

  function popupCode( url ) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }

  function toggleCode( id ) {
    if ( document.getElementById )
      elem = document.getElementById( id );
    else if ( document.all )
      elem = eval( "document.all." + id );
    else
      return false;

    elemStyle = elem.style;
    
    if ( elemStyle.display != "block" ) {
      elemStyle.display = "block"
    } else {
      elemStyle.display = "none"
    }

    return true;
  }
  
  // Make codeblocks hidden by default
  document.writeln( "<style type=\"text/css\">div.method-source-code { display: none }</style>" )
  
  // ]]>
  </script>

</head>
<body>



    <div id="classHeader">
        <table class="header-table">
        <tr class="top-aligned-row">
          <td><strong>Class</strong></td>
          <td class="class-name-in-header">ClockApp</td>
        </tr>
        <tr class="top-aligned-row">
            <td><strong>In:</strong></td>
            <td>
                <a href="../files/plugins/demo_app/demo_app_rb.html">
                plugins/demo_app/demo_app.rb
                </a>
        <br />
            </td>
        </tr>

        <tr class="top-aligned-row">
            <td><strong>Parent:</strong></td>
            <td>
                <a href="Plugin.html">
                Plugin
               </a>
            </td>
        </tr>
        </table>
    </div>
  <!-- banner header -->

  <div id="bodyContent">



  <div id="contextContent">
    <div id="diagram">
      <map id="map" name="map">
  <area shape="rect" coords="5,101,80,149"      href="ClockApp.html" alt="ClockApp" />
  <area shape="rect" coords="7,5,79,53"      href="Plugin.html" alt="Plugin" />
</map>
<img src="../dot/f_20.gif" usemap="#map" border="0" alt="dot/f_20.gif">
    </div>

    <div id="description">
      <p>
Create Himle Application instances like this. See lib/app/application.rb
for details about the prototype
</p>

    </div>


   </div>

    <div id="method-list">
      <h3 class="section-bar">Methods</h3>

      <div class="name-list">
      <a href="#M000111">calc_clock_coords</a>&nbsp;&nbsp;
      <a href="#M000115">close</a>&nbsp;&nbsp;
      <a href="#M000120">idle</a>&nbsp;&nbsp;
      <a href="#M000117">init_ses</a>&nbsp;&nbsp;
      <a href="#M000121">init_ui</a>&nbsp;&nbsp;
      <a href="#M000110">new</a>&nbsp;&nbsp;
      <a href="#M000114">open</a>&nbsp;&nbsp;
      <a href="#M000112">render_clock_bg</a>&nbsp;&nbsp;
      <a href="#M000113">render_clock_fg</a>&nbsp;&nbsp;
      <a href="#M000118">restore_ses</a>&nbsp;&nbsp;
      <a href="#M000116">tick_responder</a>&nbsp;&nbsp;
      <a href="#M000119">update_clock</a>&nbsp;&nbsp;
      </div>
    </div>

  </div>


    <!-- if includes -->

    <div id="section">





      


    <!-- if method_list -->
    <div id="methods">
      <h3 class="section-bar">Public Class methods</h3>

      <div id="method-M000110" class="method-detail">
        <a name="M000110"></a>

        <div class="method-heading">
          <a href="#M000110" class="method-signature">
          <span class="method-name">new</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000110-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000110-source">
<pre>
    <span class="ruby-comment cmt"># File plugins/demo_app/demo_app.rb, line 30</span>
30:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">initialize</span>
31:     
32:     <span class="ruby-keyword kw">super</span>
33:     
34:     <span class="ruby-comment cmt"># This string stores the clock background image url</span>
35:     <span class="ruby-comment cmt"># It is defined in ClockApp::render_clock_bg()</span>
36:     <span class="ruby-ivar">@clock_bg_img_url</span> = <span class="ruby-value str">''</span>
37:     
38:     <span class="ruby-comment cmt"># Specify the clock dimensions:</span>
39:     <span class="ruby-ivar">@clock_width</span>  = <span class="ruby-value">256</span>
40:     <span class="ruby-ivar">@clock_height</span> = <span class="ruby-value">256</span>
41:     
42:     <span class="ruby-comment cmt"># Specify the clock center coordinate:</span>
43:     <span class="ruby-ivar">@clock_center_x</span> = <span class="ruby-value">128</span>
44:     <span class="ruby-ivar">@clock_center_y</span> = <span class="ruby-value">128</span>
45:     
46:     <span class="ruby-comment cmt"># Specify the clock style</span>
47:     <span class="ruby-ivar">@background_color</span>   = <span class="ruby-value str">'#ccc'</span> <span class="ruby-comment cmt"># light gray</span>
48:     <span class="ruby-ivar">@background_opacity</span> = <span class="ruby-value">0</span><span class="ruby-value">.5</span>    <span class="ruby-comment cmt"># 50% transparent</span>
49:     
50:     <span class="ruby-ivar">@border_color</span>     = <span class="ruby-value str">'#ccc'</span> <span class="ruby-comment cmt"># light gray</span>
51:     <span class="ruby-ivar">@border_opacity</span>   = <span class="ruby-value">0</span><span class="ruby-value">.75</span>   <span class="ruby-comment cmt"># 25% transparent</span>
52:     <span class="ruby-ivar">@border_thickness</span> = <span class="ruby-value">6</span>      <span class="ruby-comment cmt"># 6 pixels wide circle</span>
53:     
54:     <span class="ruby-ivar">@hours_dot_color</span>    = <span class="ruby-value str">'#666'</span> <span class="ruby-comment cmt"># medium gray</span>
55:     <span class="ruby-ivar">@hours_dot_opacity</span>  = <span class="ruby-value">0</span><span class="ruby-value">.66</span>   <span class="ruby-comment cmt"># 33% transparent</span>
56:     <span class="ruby-ivar">@hours_dot_position</span> = <span class="ruby-value">124</span>    <span class="ruby-comment cmt"># pixels from center</span>
57:     <span class="ruby-ivar">@hours_dot_size</span>     = <span class="ruby-value">3</span>      <span class="ruby-comment cmt"># circle radius (diameter / 2)</span>
58:     
59:     <span class="ruby-comment cmt"># Specify the lengths of the clock arms:</span>
60:     <span class="ruby-ivar">@hour_arm_length</span>   = <span class="ruby-value">80</span>
61:     <span class="ruby-ivar">@minute_arm_length</span> = <span class="ruby-value">120</span>
62:     
63:     <span class="ruby-comment cmt"># Specify the style of the clock arms:</span>
64:     <span class="ruby-ivar">@clock_arms_opacity</span> = <span class="ruby-value">0</span><span class="ruby-value">.75</span>
65:     
66:     <span class="ruby-ivar">@hour_arm_color</span>     = <span class="ruby-value str">'#333'</span> <span class="ruby-comment cmt"># dark gray</span>
67:     <span class="ruby-ivar">@hour_arm_width</span>     = <span class="ruby-value">8</span>
68:     
69:     <span class="ruby-ivar">@minute_arm_color</span>   = <span class="ruby-value str">'#999'</span> <span class="ruby-comment cmt"># medium-light gray</span>
70:     <span class="ruby-ivar">@minute_arm_width</span>   = <span class="ruby-value">4</span>
71:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <h3 class="section-bar">Public Instance methods</h3>

      <div id="method-M000111" class="method-detail">
        <a name="M000111"></a>

        <div class="method-heading">
          <a href="#M000111" class="method-signature">
          <span class="method-name">calc_clock_coords</span><span class="method-args">( step, steps_max, distance_from_center )</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Trigonometric utility to calculate coordinates
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000111-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000111-source">
<pre>
    <span class="ruby-comment cmt"># File plugins/demo_app/demo_app.rb, line 74</span>
74:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">calc_clock_coords</span>( <span class="ruby-identifier">step</span>, <span class="ruby-identifier">steps_max</span>, <span class="ruby-identifier">distance_from_center</span> )
75:     <span class="ruby-identifier">angle_step_degrees</span> = (<span class="ruby-value">360.0</span><span class="ruby-operator">/</span><span class="ruby-identifier">steps_max</span>).<span class="ruby-identifier">round</span>
76:     <span class="ruby-identifier">angle</span> = ((<span class="ruby-identifier">step</span><span class="ruby-operator">*</span><span class="ruby-identifier">angle_step_degrees</span><span class="ruby-operator">-</span><span class="ruby-value">180.0</span>) <span class="ruby-operator">*</span> <span class="ruby-constant">Math</span><span class="ruby-operator">::</span><span class="ruby-constant">PI</span>) <span class="ruby-operator">/</span> <span class="ruby-value">180.0</span>
77:     <span class="ruby-identifier">x</span> = (<span class="ruby-value">0</span><span class="ruby-operator">-</span><span class="ruby-constant">Math</span>.<span class="ruby-identifier">sin</span>(<span class="ruby-identifier">angle</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">distance_from_center</span>).<span class="ruby-identifier">round</span> <span class="ruby-operator">+</span> <span class="ruby-ivar">@clock_center_x</span>
78:     <span class="ruby-identifier">y</span> = (<span class="ruby-value">0</span><span class="ruby-operator">+</span><span class="ruby-constant">Math</span>.<span class="ruby-identifier">cos</span>(<span class="ruby-identifier">angle</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">distance_from_center</span>).<span class="ruby-identifier">round</span> <span class="ruby-operator">+</span> <span class="ruby-ivar">@clock_center_y</span>
79:     <span class="ruby-keyword kw">return</span> [<span class="ruby-identifier">x</span>,<span class="ruby-identifier">y</span>]
80:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000115" class="method-detail">
        <a name="M000115"></a>

        <div class="method-heading">
          <a href="#M000115" class="method-signature">
          <span class="method-name">close</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Remove the background image from the cache, when the <a
href="ClockApp.html#M000115">close</a> event is triggered:
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000115-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000115-source">
<pre>
     <span class="ruby-comment cmt"># File plugins/demo_app/demo_app.rb, line 198</span>
198:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">close</span>
199:     <span class="ruby-constant">TICKETSERVE</span>.<span class="ruby-identifier">del_rsrc</span>( <span class="ruby-ivar">@clock_bg_img_url</span> )
200:     <span class="ruby-ivar">@clock_bg_img_url</span> = <span class="ruby-value str">''</span>
201:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000120" class="method-detail">
        <a name="M000120"></a>

        <div class="method-heading">
          <a href="#M000120" class="method-signature">
          <span class="method-name">idle</span><span class="method-args">(msg)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Called on every client request:
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000120-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000120-source">
<pre>
     <span class="ruby-comment cmt"># File plugins/demo_app/demo_app.rb, line 288</span>
288:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">idle</span>(<span class="ruby-identifier">msg</span>)
289:     
290:     <span class="ruby-comment cmt"># Don't do anything, if the main app hasn't been initialized:</span>
291:     <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">if</span> <span class="ruby-keyword kw">not</span> <span class="ruby-identifier">msg</span>.<span class="ruby-identifier">session</span>.<span class="ruby-identifier">has_key?</span>(<span class="ruby-identifier">:main</span>)
292:     
293:     <span class="ruby-comment cmt"># Init the ui, when the first request to the main app is complete:</span>
294:     <span class="ruby-identifier">init_ui</span>(<span class="ruby-identifier">msg</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">msg</span>.<span class="ruby-identifier">session</span>[<span class="ruby-identifier">:main</span>][<span class="ruby-identifier">:boot</span>] <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
295:     
296:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000117" class="method-detail">
        <a name="M000117"></a>

        <div class="method-heading">
          <a href="#M000117" class="method-signature">
          <span class="method-name">init_ses</span><span class="method-args">(msg)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
New session initialization, called once per session.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000117-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000117-source">
<pre>
     <span class="ruby-comment cmt"># File plugins/demo_app/demo_app.rb, line 235</span>
235:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">init_ses</span>(<span class="ruby-identifier">msg</span>)
236:     
237:     <span class="ruby-comment cmt"># Render the initial clock arms</span>
238:     <span class="ruby-identifier">clock_fg_url</span> = <span class="ruby-identifier">render_clock_fg</span>(<span class="ruby-identifier">msg</span>)
239:     
240:     <span class="ruby-comment cmt"># Store some data into the session-specific data storage:</span>
241:     <span class="ruby-identifier">msg</span>.<span class="ruby-identifier">session</span>[<span class="ruby-identifier">:clock_app</span>] = {
242:       
243:       <span class="ruby-comment cmt"># Define a HValue. It's an automatically syncronized data</span>
244:       <span class="ruby-comment cmt"># message object shared between server and client.</span>
245:       
246:       <span class="ruby-comment cmt"># Here we are using it to send the clock arms'</span>
247:       <span class="ruby-comment cmt"># image url to the client.</span>
248:       <span class="ruby-identifier">:clock_fg_url</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">HValue</span>.<span class="ruby-identifier">new</span>( <span class="ruby-identifier">msg</span>, <span class="ruby-identifier">clock_fg_url</span> )
249:       
250:     }
251:     
252:     <span class="ruby-comment cmt"># Bind the main application's client_time HValue instance</span>
253:     <span class="ruby-comment cmt"># to our tick_reponder method:</span>
254:     <span class="ruby-identifier">msg</span>.<span class="ruby-identifier">session</span>[<span class="ruby-identifier">:main</span>][<span class="ruby-identifier">:client_time</span>].<span class="ruby-identifier">bind</span>( <span class="ruby-value str">'clock_app'</span>, <span class="ruby-value str">'tick_responder'</span>)
255:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000121" class="method-detail">
        <a name="M000121"></a>

        <div class="method-heading">
          <a href="#M000121" class="method-signature">
          <span class="method-name">init_ui</span><span class="method-args">(msg)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Initializes the client&#8216;s UI
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000121-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000121-source">
<pre>
     <span class="ruby-comment cmt"># File plugins/demo_app/demo_app.rb, line 299</span>
299:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">init_ui</span>(<span class="ruby-identifier">msg</span>)
300:     
301:     <span class="ruby-comment cmt"># Load a list of dependencies (well, only basic is required for now)</span>
302:     <span class="ruby-identifier">include_js</span>( <span class="ruby-identifier">msg</span>, <span class="ruby-value str">'basic'</span> )
303:     
304:     <span class="ruby-comment cmt"># Load the client initialization javascript from the js dir:</span>
305:     <span class="ruby-identifier">msg</span>.<span class="ruby-identifier">reply</span> <span class="ruby-identifier">require_js</span>(<span class="ruby-value str">'demo_app'</span>)
306:     
307:     <span class="ruby-comment cmt"># Get the value id of the clock arm image url message (HValue):</span>
308:     <span class="ruby-identifier">clock_fg_url_id</span> = <span class="ruby-identifier">msg</span>.<span class="ruby-identifier">session</span>[<span class="ruby-identifier">:clock_app</span>][<span class="ruby-identifier">:clock_fg_url</span>].<span class="ruby-identifier">val_id</span>
309:     
310:     <span class="ruby-comment cmt"># Initialize the client with background image url and foreground image value id</span>
311:     <span class="ruby-identifier">msg</span>.<span class="ruby-identifier">reply</span> <span class="ruby-node">&quot;clockApp = new ClockApp(#{@clock_width},#{@clock_height},'#{@clock_bg_img_url}','#{clock_fg_url_id}');&quot;</span>
312:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000114" class="method-detail">
        <a name="M000114"></a>

        <div class="method-heading">
          <a href="#M000114" class="method-signature">
          <span class="method-name">open</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Render the background image, when the <a
href="ClockApp.html#M000114">open</a> event is triggered:
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000114-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000114-source">
<pre>
     <span class="ruby-comment cmt"># File plugins/demo_app/demo_app.rb, line 192</span>
192:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">open</span>
193:     <span class="ruby-identifier">render_clock_bg</span>
194:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000112" class="method-detail">
        <a name="M000112"></a>

        <div class="method-heading">
          <a href="#M000112" class="method-signature">
          <span class="method-name">render_clock_bg</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Renders the clock background, it&#8216;s shared amongst sessions and
it&#8216;s rendered once only, when the application starts. It&#8216;s
called from ClockApp::open()
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000112-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000112-source">
<pre>
     <span class="ruby-comment cmt"># File plugins/demo_app/demo_app.rb, line 85</span>
 85:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">render_clock_bg</span>
 86:     
 87:     <span class="ruby-comment cmt"># Create the image object</span>
 88:     <span class="ruby-identifier">clock_bg</span> = <span class="ruby-constant">Magick</span><span class="ruby-operator">::</span><span class="ruby-constant">Image</span>.<span class="ruby-identifier">new</span>( <span class="ruby-ivar">@clock_width</span>, <span class="ruby-ivar">@clock_height</span> ) { 
 89:       <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">background_color</span> = <span class="ruby-value str">'transparent'</span>
 90:     }
 91:     
 92:     <span class="ruby-comment cmt"># Create the drawing command object</span>
 93:     <span class="ruby-identifier">draw_bg</span> = <span class="ruby-constant">Magick</span><span class="ruby-operator">::</span><span class="ruby-constant">Draw</span>.<span class="ruby-identifier">new</span>
 94:     
 95:     <span class="ruby-comment cmt"># Set styles for circle:</span>
 96:     <span class="ruby-identifier">draw_bg</span>.<span class="ruby-identifier">fill</span>( <span class="ruby-ivar">@background_color</span> )
 97:     <span class="ruby-identifier">draw_bg</span>.<span class="ruby-identifier">fill_opacity</span>( <span class="ruby-ivar">@background_opacity</span> )
 98:     <span class="ruby-identifier">draw_bg</span>.<span class="ruby-identifier">stroke</span>( <span class="ruby-ivar">@border_color</span> )
 99:     <span class="ruby-identifier">draw_bg</span>.<span class="ruby-identifier">stroke_width</span>( <span class="ruby-ivar">@border_thickness</span> )
100:     <span class="ruby-identifier">draw_bg</span>.<span class="ruby-identifier">stroke_opacity</span>( <span class="ruby-ivar">@border_opacity</span> )
101:     
102:     <span class="ruby-comment cmt"># Draw circle:</span>
103:     <span class="ruby-identifier">draw_bg</span>.<span class="ruby-identifier">circle</span>(
104:       <span class="ruby-ivar">@clock_center_x</span>, <span class="ruby-ivar">@clock_center_y</span>,    <span class="ruby-comment cmt"># circle center point</span>
105:       <span class="ruby-ivar">@border_thickness</span><span class="ruby-operator">/</span><span class="ruby-value">2</span>, <span class="ruby-ivar">@clock_center_y</span> <span class="ruby-comment cmt"># circle left edge point</span>
106:     )
107:     
108:     <span class="ruby-comment cmt"># Set styles for hour dots:</span>
109:     <span class="ruby-identifier">draw_bg</span>.<span class="ruby-identifier">fill</span>( <span class="ruby-ivar">@hours_dot_color</span> )
110:     <span class="ruby-identifier">draw_bg</span>.<span class="ruby-identifier">fill_opacity</span>( <span class="ruby-ivar">@hours_dot_opacity</span> )
111:     <span class="ruby-identifier">draw_bg</span>.<span class="ruby-identifier">stroke</span>( <span class="ruby-value str">'transparent'</span> ) <span class="ruby-comment cmt"># no stroke</span>
112:     <span class="ruby-identifier">draw_bg</span>.<span class="ruby-identifier">stroke_width</span>( <span class="ruby-value">0</span> )       <span class="ruby-comment cmt"># no stroke</span>
113:     
114:     <span class="ruby-comment cmt"># Draw circles for each hour</span>
115:     <span class="ruby-value">12</span>.<span class="ruby-identifier">times</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">hour</span><span class="ruby-operator">|</span>
116:       (<span class="ruby-identifier">x</span>,<span class="ruby-identifier">y</span>) = <span class="ruby-identifier">calc_clock_coords</span>( <span class="ruby-identifier">hour</span>, <span class="ruby-value">12</span>, <span class="ruby-ivar">@hours_dot_position</span> )
117:       (<span class="ruby-identifier">x2</span>,<span class="ruby-identifier">y2</span>) = <span class="ruby-identifier">calc_clock_coords</span>( <span class="ruby-identifier">hour</span>, <span class="ruby-value">12</span>, <span class="ruby-ivar">@hours_dot_position</span> <span class="ruby-operator">+</span> <span class="ruby-ivar">@hours_dot_size</span> )
118:       <span class="ruby-identifier">draw_bg</span>.<span class="ruby-identifier">circle</span>(<span class="ruby-identifier">x</span>,<span class="ruby-identifier">y</span>,<span class="ruby-identifier">x2</span>,<span class="ruby-identifier">y2</span>)
119:     <span class="ruby-keyword kw">end</span>
120:     
121:     <span class="ruby-comment cmt"># Render the drawing commands to pixels:</span>
122:     <span class="ruby-identifier">draw_bg</span>.<span class="ruby-identifier">draw</span>( <span class="ruby-identifier">clock_bg</span> )
123:     
124:     <span class="ruby-comment cmt"># Convert the raw pixels to png-image data</span>
125:     <span class="ruby-identifier">clock_img_data</span> = <span class="ruby-identifier">clock_bg</span>.<span class="ruby-identifier">to_blob</span>{ <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">format</span>=<span class="ruby-value str">'PNG'</span> }
126:     
127:     <span class="ruby-comment cmt"># Send the image to the TICKETSERVE cache as a 'resource', basically</span>
128:     <span class="ruby-comment cmt"># meaning that it should be stored forever or until it's manually removed.</span>
129:     <span class="ruby-comment cmt"># It returns a generated uri stored as @clock_bg_img_url</span>
130:     <span class="ruby-ivar">@clock_bg_img_url</span> = <span class="ruby-constant">TICKETSERVE</span>.<span class="ruby-identifier">serve_rsrc</span>( <span class="ruby-identifier">clock_img_data</span>, <span class="ruby-value str">'image/png'</span> )
131:     
132:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000113" class="method-detail">
        <a name="M000113"></a>

        <div class="method-heading">
          <a href="#M000113" class="method-signature">
          <span class="method-name">render_clock_fg</span><span class="method-args">(msg, time_now=false)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Renders the clock foreground, it&#8216;s a disposable image sent only once
to the client. It takes an optional parameter; time specified in seconds
since epoch
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000113-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000113-source">
<pre>
     <span class="ruby-comment cmt"># File plugins/demo_app/demo_app.rb, line 139</span>
139:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">render_clock_fg</span>(<span class="ruby-identifier">msg</span>, <span class="ruby-identifier">time_now</span>=<span class="ruby-keyword kw">false</span>)
140:     
141:     <span class="ruby-comment cmt"># Create a date/time object based on the argument given </span>
142:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">time_now</span> <span class="ruby-operator">==</span> <span class="ruby-keyword kw">false</span>
143:       <span class="ruby-identifier">time_now</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>
144:     <span class="ruby-keyword kw">else</span>
145:       <span class="ruby-identifier">time_now</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">at</span>( <span class="ruby-identifier">time_now</span> )
146:     <span class="ruby-keyword kw">end</span>
147:     
148:     <span class="ruby-comment cmt"># Get the time in 12.(minutes*1.66) -format</span>
149:     <span class="ruby-identifier">hour</span> = <span class="ruby-identifier">time_now</span>.<span class="ruby-identifier">hour</span>
150:     <span class="ruby-identifier">hour</span> <span class="ruby-operator">-=</span> <span class="ruby-value">12</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">hour</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-value">12</span>
151:     <span class="ruby-identifier">minutes</span> = <span class="ruby-identifier">time_now</span>.<span class="ruby-identifier">min</span>
152:     <span class="ruby-identifier">hour</span> <span class="ruby-operator">+=</span> (<span class="ruby-identifier">minutes</span><span class="ruby-operator">/</span><span class="ruby-value">60.0</span>)
153:     
154:     <span class="ruby-comment cmt"># Create the image object</span>
155:     <span class="ruby-identifier">clock_fg</span> = <span class="ruby-constant">Magick</span><span class="ruby-operator">::</span><span class="ruby-constant">Image</span>.<span class="ruby-identifier">new</span>( <span class="ruby-ivar">@clock_width</span>, <span class="ruby-ivar">@clock_height</span> ) { 
156:       <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">background_color</span> = <span class="ruby-value str">'transparent'</span>
157:     }
158:     
159:     <span class="ruby-comment cmt"># Create the drawing command object</span>
160:     <span class="ruby-identifier">draw_fg</span> = <span class="ruby-constant">Magick</span><span class="ruby-operator">::</span><span class="ruby-constant">Draw</span>.<span class="ruby-identifier">new</span>
161:     
162:     <span class="ruby-comment cmt"># Set clock arm style</span>
163:     <span class="ruby-identifier">draw_fg</span>.<span class="ruby-identifier">stroke_opacity</span>( <span class="ruby-ivar">@clock_arms_opacity</span> )
164:     
165:     <span class="ruby-identifier">draw_fg</span>.<span class="ruby-identifier">stroke</span>( <span class="ruby-ivar">@hour_arm_color</span> )
166:     <span class="ruby-identifier">draw_fg</span>.<span class="ruby-identifier">stroke_width</span>( <span class="ruby-ivar">@hour_arm_width</span> )
167:     
168:     <span class="ruby-comment cmt"># Draw the hour arm:</span>
169:     (<span class="ruby-identifier">hour_x</span>,<span class="ruby-identifier">hour_y</span>) = <span class="ruby-identifier">calc_clock_coords</span>(<span class="ruby-identifier">hour</span>,<span class="ruby-value">12</span>,<span class="ruby-ivar">@hour_arm_length</span>)
170:     <span class="ruby-identifier">draw_fg</span>.<span class="ruby-identifier">line</span>(<span class="ruby-ivar">@clock_center_x</span>,<span class="ruby-ivar">@clock_center_y</span>,<span class="ruby-identifier">hour_x</span>,<span class="ruby-identifier">hour_y</span>)
171:     
172:     <span class="ruby-comment cmt"># Set the minute arm style:</span>
173:     <span class="ruby-identifier">draw_fg</span>.<span class="ruby-identifier">stroke</span>( <span class="ruby-ivar">@minute_arm_color</span> )
174:     <span class="ruby-identifier">draw_fg</span>.<span class="ruby-identifier">stroke_width</span>( <span class="ruby-ivar">@minute_arm_width</span> )
175:     
176:     <span class="ruby-comment cmt"># Draw the minute arm:</span>
177:     (<span class="ruby-identifier">minutes_x</span>,<span class="ruby-identifier">minutes_y</span>) = <span class="ruby-identifier">calc_clock_coords</span>(<span class="ruby-identifier">minutes</span>,<span class="ruby-value">60</span>,<span class="ruby-ivar">@minute_arm_length</span>)
178:     <span class="ruby-identifier">draw_fg</span>.<span class="ruby-identifier">line</span>(<span class="ruby-ivar">@clock_center_x</span>,<span class="ruby-ivar">@clock_center_y</span>,<span class="ruby-identifier">minutes_x</span>,<span class="ruby-identifier">minutes_y</span>)
179:     
180:     <span class="ruby-comment cmt"># Render the drawing commands to pixels:</span>
181:     <span class="ruby-identifier">draw_fg</span>.<span class="ruby-identifier">draw</span>( <span class="ruby-identifier">clock_fg</span> )
182:     
183:     <span class="ruby-comment cmt"># Store the image as a disposable image object, it expires automatically.</span>
184:     <span class="ruby-identifier">clock_fg_img_url</span> = <span class="ruby-identifier">msg</span>.<span class="ruby-identifier">serve_img</span>(<span class="ruby-identifier">clock_fg</span>,<span class="ruby-value str">'PNG'</span>)
185:     
186:     <span class="ruby-comment cmt"># Return the image uri returned by the image cache</span>
187:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">clock_fg_img_url</span>
188:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000118" class="method-detail">
        <a name="M000118"></a>

        <div class="method-heading">
          <a href="#M000118" class="method-signature">
          <span class="method-name">restore_ses</span><span class="method-args">(msg)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Called when a session is restored from cookie (essentially when the user
reloads or comes back from other pages, while the session is alive)
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000118-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000118-source">
<pre>
     <span class="ruby-comment cmt"># File plugins/demo_app/demo_app.rb, line 259</span>
259:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">restore_ses</span>(<span class="ruby-identifier">msg</span>)
260:     
261:     <span class="ruby-comment cmt"># The session should be initalized for this app,</span>
262:     <span class="ruby-comment cmt"># unless it's been done, in which case it's data</span>
263:     <span class="ruby-comment cmt"># will be reset.</span>
264:     
265:     <span class="ruby-identifier">ses</span> = <span class="ruby-identifier">msg</span>.<span class="ruby-identifier">session</span>
266:     <span class="ruby-keyword kw">if</span> <span class="ruby-keyword kw">not</span> <span class="ruby-identifier">ses</span>.<span class="ruby-identifier">has_key?</span>(<span class="ruby-identifier">:clock_app</span>)
267:       <span class="ruby-identifier">init_ses</span>(<span class="ruby-identifier">msg</span>)
268:     <span class="ruby-keyword kw">else</span>
269:       <span class="ruby-identifier">update_clock</span>(<span class="ruby-identifier">msg</span>)
270:     <span class="ruby-keyword kw">end</span>
271:     
272:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000116" class="method-detail">
        <a name="M000116"></a>

        <div class="method-heading">
          <a href="#M000116" class="method-signature">
          <span class="method-name">tick_responder</span><span class="method-args">(msg, client_time)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
This method is called whenever the value in the [:main][:client_time] value
changed. It&#8216;s basically 60 seconds as defined in the <a
href="Main.html">Main</a> application&#8216;s client part.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000116-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000116-source">
<pre>
     <span class="ruby-comment cmt"># File plugins/demo_app/demo_app.rb, line 212</span>
212:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">tick_responder</span>(<span class="ruby-identifier">msg</span>, <span class="ruby-identifier">client_time</span>)
213:     
214:     <span class="ruby-comment cmt"># This application's session data storage</span>
215:     <span class="ruby-comment cmt"># (see ClockApp::init_ses)</span>
216:     <span class="ruby-identifier">clock_ses</span> = <span class="ruby-identifier">msg</span>.<span class="ruby-identifier">session</span>[<span class="ruby-identifier">:clock_app</span>]
217:     
218:     <span class="ruby-comment cmt"># If configured to true, use clien't time..</span>
219:     <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@use_client_time</span>
220:       <span class="ruby-identifier">time_now</span> = <span class="ruby-identifier">client_time</span>
221:     
222:     <span class="ruby-comment cmt"># otherwise server time:</span>
223:     <span class="ruby-keyword kw">else</span>
224:       <span class="ruby-identifier">time_now</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">to_i</span>
225:     <span class="ruby-keyword kw">end</span>
226:     
227:     <span class="ruby-comment cmt"># Redraws the clock arms:</span>
228:     <span class="ruby-identifier">update_clock</span>(<span class="ruby-identifier">msg</span>, <span class="ruby-identifier">time_now</span>)
229:     
230:     <span class="ruby-comment cmt"># Always returns true validation:</span>
231:     <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">true</span>
232:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000119" class="method-detail">
        <a name="M000119"></a>

        <div class="method-heading">
          <a href="#M000119" class="method-signature">
          <span class="method-name">update_clock</span><span class="method-args">(msg, time_now=false)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Re-renders the clock arms, time_now is either false or an integer
representing seconds since epoch:
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000119-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000119-source">
<pre>
     <span class="ruby-comment cmt"># File plugins/demo_app/demo_app.rb, line 276</span>
276:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">update_clock</span>(<span class="ruby-identifier">msg</span>, <span class="ruby-identifier">time_now</span>=<span class="ruby-keyword kw">false</span>)
277:     
278:     <span class="ruby-identifier">clock_ses</span> = <span class="ruby-identifier">msg</span>.<span class="ruby-identifier">session</span>[<span class="ruby-identifier">:clock_app</span>]
279:     
280:     <span class="ruby-comment cmt"># Re-render the clock arms:</span>
281:     <span class="ruby-identifier">clock_fg_url</span> = <span class="ruby-identifier">render_clock_fg</span>(<span class="ruby-identifier">msg</span>,<span class="ruby-identifier">time_now</span>)
282:     
283:     <span class="ruby-comment cmt"># Tell the client what the url to the image is:</span>
284:     <span class="ruby-identifier">clock_ses</span>[<span class="ruby-identifier">:clock_fg_url</span>].<span class="ruby-identifier">set</span>( <span class="ruby-identifier">msg</span>, <span class="ruby-identifier">clock_fg_url</span> )
285:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>


    </div>


  </div>


<div id="validator-badges">
  <p><small><a href="http://validator.w3.org/check/referer">[Validate]</a></small></p>
</div>

</body>
</html>